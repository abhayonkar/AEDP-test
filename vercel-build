#!/bin/bash

# Exit immediately if a command exits with a non-zero status.
set -e

# PART 1: Install system dependencies
echo "--- Installing WeasyPrint System Dependencies ---"
yum install -y pango cairo gdk-pixbuf2 fontconfig libffi

# PART 2: Create lib directory and copy all .so files from the system lib path
# This is a "sledgehammer" approach to ensure no dependency is missed.
echo "--- Packaging all shared libraries from /usr/lib64 ---"
mkdir -p lib
cp -R /usr/lib64/* lib/

# PART 3: Create font configuration
echo "--- Creating custom fontconfig configuration ---"
mkdir -p .config/fontconfig
cat > .config/fontconfig/fonts.conf << EOL
<?xml version="1.0"?>
<!DOCTYPE fontconfig SYSTEM "fonts.dtd">
<fontconfig>
  <dir>/usr/share/fonts</dir>
  <dir>/var/task/.fonts</dir>
  <cachedir>/tmp/fontconfig</cachedir>
  <config></config>
</fontconfig>
EOL

# PART 4: Run Django's collectstatic
echo "--- Collecting Django Static Files ---"
python3.12 manage.py collectstatic --noinput --clear

echo "--- Build Script Finished Successfully ---"
